<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>">
    <title>Gestor de Planificaci贸n - LLYC</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=62">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
</head>

<body>
    <div class="login-page" id="login-page">
        <div class="login-container">
            <div class="login-brand">LLYC</div>
            <h1>Gestor de Planificaci贸n</h1>
            <p class="login-subtitle">Sistema de Planificaci贸n de Recursos</p>
            <form id="login-form" onsubmit="event.preventDefault(); app.handleLogin();">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="login-username" placeholder="usuario" value="">
                </div>
                <div class="form-group">
                    <label>Contrase帽a</label>
                    <input type="password" id="login-password" placeholder="" value="">
                </div>
                <button type="submit" class="login-button">Acceder</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="navbar">
            <div class="navbar-brand">
                <span class="brand-llyc">LLYC</span>
                <span class="brand-separator">|</span>
                <span class="brand-title">Planificador de Recursos</span>
            </div>
            <div class="navbar-menu">
                <button class="nav-menu-item active" onclick="app.navigateTo('dashboard')"
                    id="nav-dashboard"><i class="fas fa-chart-pie"></i> Resumen</button>
                <button class="nav-menu-item" onclick="app.navigateTo('viewer')"
                    id="nav-viewer"><i class="fas fa-eye"></i> Visor</button>
                <button class="nav-menu-item" onclick="app.navigateTo('planning')"
                    id="nav-planning"><i class="fas fa-calendar-alt"></i> Planificaci贸n</button>
                <button class="nav-menu-item" onclick="app.navigateTo('comparativo')"
                    id="nav-comparativo"><i class="fas fa-balance-scale"></i> Real vs Plan</button>
                <button class="nav-menu-item" onclick="app.navigateTo('config')" id="nav-config"><i class="fas fa-cog"></i> Configuraci贸n</button>
            </div>
            <div class="navbar-user">
                <span id="navbar-username" style="color: var(--llyc-gray-subtext); font-size: 13px;">Admin</span>
                <button onclick="app.logout()" class="btn-logout" title="Cerrar sesi贸n">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <main class="dashboard">
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="view-section">
                <div class="section-header">
                    <h2 class="section-title">Resumen de Planificaci贸n</h2>
                    <p class="section-subtitle">Visi贸n general de la asignaci贸n de recursos y carga de trabajo</p>
                </div>

                <!-- Date Range Selector -->
                <div class="section-card">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Regi贸n</label>
                            <select id="dash-region" class="form-control" onchange="app.onDashRegionChange()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Pa铆s</label>
                            <select id="dash-pais" class="form-control" onchange="app.onDashPaisChange()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>rea</label>
                            <select id="dash-area" class="form-control" onchange="app.updateDashboard()"></select>
                        </div>
                        <div class="filter-group">
                            <label>Inicio</label>
                            <input type="date" id="dash-start-date" class="form-control">
                        </div>
                        <div class="filter-group">
                            <label>Fin</label>
                            <input type="date" id="dash-end-date" class="form-control">
                        </div>
                        <button onclick="app.updateDashboard()" class="btn btn-primary">Actualizar</button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Horas Asignadas</div>
                        <div class="stat-value" id="dash-total-hours">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Colaboradores Activos</div>
                        <div class="stat-value" id="dash-active-collaborators">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Proyectos Activos/En curso</div>
                        <div class="stat-value" id="dash-active-projects">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Promedio de Asignaci贸n</div>
                        <div class="stat-value" id="dash-avg-allocation">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Personas en Vacaciones/Feriado</div>
                        <div class="stat-value" id="dash-vacation-collaborators">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Personas en Capacitaci贸n/Innovaci贸n</div>
                        <div class="stat-value" id="dash-training-collaborators">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Horas de Capacitaci贸n</div>
                        <div class="stat-value" id="dash-training-hours">0h</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Distribuci贸n por Tipo de Proyecto</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="project-type-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Horas por Colaborador</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="collaborator-hours-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEWER VIEW (Solo lectura) -->
            <div id="view-viewer" class="view-section hidden">
                <div class="section-header">
                    <h2 class="section-title">Visor de Planificaci贸n</h2>
                    <p class="section-subtitle">Consulta de asignaciones por semana (solo lectura)</p>
                </div>
                <div class="section-card" style="margin-bottom: 24px;">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Regi贸n</label>
                            <select id="viewer-region" class="form-control" onchange="app.onViewerRegionChange()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Pa铆s</label>
                            <select id="viewer-pais" class="form-control" onchange="app.onViewerPaisChange()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>rea</label>
                            <select id="viewer-area" class="form-control" onchange="app.loadViewer()"></select>
                        </div>
                        <div class="filter-group">
                            <label>A帽o</label>
                            <select id="viewer-year" class="form-control" onchange="app.onViewerYearChange()"></select>
                        </div>
                        <div class="filter-group">
                            <label>Semana</label>
                            <select id="viewer-week" class="form-control" onchange="app.loadViewer()"></select>
                        </div>
                    </div>
                </div>
                <div class="section-card planning-grid-wrapper">
                    <table class="data-table planning-table">
                        <thead>
                            <tr>
                                <th class="col-colaborador">Colaborador</th>
                                <th class="col-asignaciones">Asignaciones</th>
                                <th class="col-total">Total</th>
                            </tr>
                        </thead>
                        <tbody id="viewer-grid-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- PLANNING VIEW -->
            <div id="view-planning" class="view-section hidden">
                <div class="section-header">
                    <h2 class="section-title">Planificaci贸n Semanal</h2>
                    <p class="section-subtitle">Consulta y gestiona asignaciones por semana</p>
                </div>
                <div class="section-card" style="margin-bottom: 24px;">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Regi贸n</label>
                            <select id="plan-region" class="form-control" onchange="app.onPlanRegionChange()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Pa铆s</label>
                            <select id="plan-pais" class="form-control" onchange="app.onPlanPaisChange()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>rea</label>
                            <select id="plan-area" class="form-control" onchange="app.loadPlanning()"></select>
                        </div>
                        <div class="filter-group">
                            <label>A帽o</label>
                            <select id="plan-year" class="form-control" onchange="app.onPlanYearChange()"></select>
                        </div>
                        <div class="filter-group">
                            <label>Semana</label>
                            <select id="plan-week" class="form-control" onchange="app.loadPlanning()"></select>
                        </div>
                        <div class="filter-actions">
                            <button onclick="app.copyPreviousWeek()" class="btn btn-secondary"><i class="fas fa-copy"></i> Copiar</button>
                            <button onclick="app.exportPlanningToExcel()" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Exportar</button>
                            <button onclick="app.deleteWeekPlanning()" class="btn btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
                            <button onclick="app.createNewPlanning()" class="btn btn-primary"><i class="fas fa-plus"></i> Nueva</button>
                        </div>
                    </div>
                </div>
                <div class="section-card planning-grid-wrapper">
                    <table class="data-table planning-table">
                        <thead>
                            <tr>
                                <th class="col-colaborador">Colaborador</th>
                                <th class="col-asignaciones">Asignaciones</th>
                                <th class="col-total">Total</th>
                            </tr>
                        </thead>
                        <tbody id="planning-grid-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- CONFIGURATION VIEW -->
            <div id="view-config" class="view-section hidden">
                <div class="section-header">
                    <h2 class="section-title">Configuraci贸n</h2>
                    <p class="section-subtitle">Gesti贸n de cat谩logos maestros del sistema</p>
                </div>
                <div class="view-tabs">
                    <button class="view-tab active" onclick="app.switchConfigTab('colaboradores')"
                        id="tab-colaboradores">Colaboradores</button>
                    <button class="view-tab" onclick="app.switchConfigTab('clientes')"
                        id="tab-clientes">Clientes</button>
                    <button class="view-tab" onclick="app.switchConfigTab('proyectos')"
                        id="tab-proyectos">Proyectos</button>
                    <button class="view-tab" onclick="app.switchConfigTab('tipos')" id="tab-tipos">Tipo de Proyecto</button>
                    <button class="view-tab" onclick="app.switchConfigTab('regiones')" id="tab-regiones">Regiones</button>
                    <button class="view-tab" onclick="app.switchConfigTab('paises')" id="tab-paises">Pa铆ses</button>
                    <button class="view-tab" onclick="app.switchConfigTab('areas')" id="tab-areas">reas</button>
                    <button class="view-tab" onclick="app.switchConfigTab('usuarios')" id="tab-usuarios">Usuarios</button>
                    <button class="view-tab" onclick="app.switchConfigTab('cor-config')" id="tab-cor-config">Conexi贸n COR</button>
                    <button class="view-tab" onclick="app.switchConfigTab('cor-mapeo')" id="tab-cor-mapeo">Mapeo COR</button>
                </div>

                <!-- Config: Colaboradores -->
                <div id="config-colaboradores" class="config-tab-content section-card">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openAddModal('colaboradores')"><i
                                class="fas fa-plus"></i>
                            A帽adir</button>
                        <button class="btn btn-secondary" onclick="app.openImportModal('colaboradores')"><i
                                class="fas fa-upload"></i> Importar CSV</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('colaboradores')"><i
                                class="fas fa-trash"></i>
                            Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('colaboradores', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th>rea</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-colaboradores"></tbody>
                    </table>
                </div>

                <!-- Config: Clientes -->
                <div id="config-clientes" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openAddModal('clientes')"><i
                                class="fas fa-plus"></i>
                            A帽adir</button>
                        <button class="btn btn-secondary" onclick="app.openImportModal('clientes')"><i
                                class="fas fa-upload"></i>
                            Importar CSV</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('clientes')"><i
                                class="fas fa-trash"></i>
                            Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('clientes', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Cliente</th>
                                <th>Regi贸n</th>
                                <th>Pa铆s</th>
                                <th>Proyecto</th>
                                <th>Tipo</th>
                                <th>rea</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-clientes"></tbody>
                    </table>
                </div>

                <!-- Config: Proyectos -->
                <div id="config-proyectos" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openAddModal('proyectos')"><i
                                class="fas fa-plus"></i>
                            A帽adir</button>
                        <button class="btn btn-secondary" onclick="app.openImportModal('proyectos')"><i
                                class="fas fa-upload"></i>
                            Importar CSV</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('proyectos')"><i
                                class="fas fa-trash"></i>
                            Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('proyectos', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-proyectos"></tbody>
                    </table>
                </div>

                <!-- Config: Tipos -->
                <div id="config-tipos" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openAddModal('tipos')"><i class="fas fa-plus"></i>
                            A帽adir</button>
                        <button class="btn btn-secondary" onclick="app.openImportModal('tipos')"><i
                                class="fas fa-upload"></i>
                            Importar CSV</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('tipos')"><i
                                class="fas fa-trash"></i>
                            Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('tipos', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-tipos"></tbody>
                    </table>
                </div>
                <!-- Config: Regiones -->
                <div id="config-regiones" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openAddModal('regiones')"><i class="fas fa-plus"></i>
                            A帽adir</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('regiones')"><i
                                class="fas fa-trash"></i>
                            Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('regiones', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th style="width: 100px;">Global</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-regiones"></tbody>
                    </table>
                </div>

                <!-- Config: Pa铆ses -->
                <div id="config-paises" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label>Filtrar por Regi贸n:</label>
                            <select id="filter-paises-region" onchange="app.loadPaises()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-left: auto;">
                            <button class="btn btn-primary" onclick="app.openAddModal('paises')"><i class="fas fa-plus"></i>
                                A帽adir</button>
                            <button class="btn btn-secondary" onclick="app.deleteSelected('paises')"><i
                                    class="fas fa-trash"></i>
                                Eliminar Seleccionados</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('paises', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th>Regi贸n</th>
                                <th style="width: 100px;">Global</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-paises"></tbody>
                    </table>
                </div>

                <!-- Config: reas (updated with region/country) -->
                <div id="config-areas" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label>Regi贸n:</label>
                            <select id="filter-areas-region" onchange="app.onAreasRegionChange()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="">Todas</option>
                            </select>
                            <label>Pa铆s:</label>
                            <select id="filter-areas-pais" onchange="app.loadAreas()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px; margin-left: auto;">
                            <button class="btn btn-primary" onclick="app.openAddModal('areas')"><i class="fas fa-plus"></i>
                                A帽adir</button>
                            <button class="btn btn-secondary" onclick="app.deleteSelected('areas')"><i
                                    class="fas fa-trash"></i>
                                Eliminar Seleccionados</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all"
                                        onchange="app.toggleSelectAll('areas', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Nombre</th>
                                <th>Regi贸n</th>
                                <th>Pa铆s</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-areas"></tbody>
                    </table>
                </div>
                <!-- Config: Usuarios -->
                <div id="config-usuarios" class="config-tab-content section-card hidden">
                    <div class="config-actions">
                        <button class="btn btn-primary" onclick="app.openUserModal()"><i class="fas fa-plus"></i> A帽adir Usuario</button>
                        <button class="btn btn-secondary" onclick="app.deleteSelected('usuarios')"><i class="fas fa-trash"></i> Eliminar Seleccionados</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;"><input type="checkbox" class="select-all" onchange="app.toggleSelectAll('usuarios', this.checked)"></th>
                                <th style="width: 80px;">ID</th>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th>rea</th>
                                <th style="width: 150px; text-align: right;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="table-usuarios"></tbody>
                    </table>
                </div>

                <!-- Config: Conexi贸n COR -->
                <div id="config-cor-config" class="config-tab-content section-card hidden">
                    <div class="cor-config-container">
                        <h3 class="cor-section-title">Configuraci贸n de API de COR</h3>
                        <div class="form-group">
                            <label>API Key</label>
                            <div class="cor-input-group">
                                <input type="password" id="cor-api-key" class="form-control" placeholder="Ingrese API Key">
                                <button type="button" class="btn btn-secondary" onclick="app.togglePasswordVisibility('cor-api-key')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Client Secret</label>
                            <div class="cor-input-group">
                                <input type="password" id="cor-client-secret" class="form-control" placeholder="Ingrese Client Secret">
                                <button type="button" class="btn btn-secondary" onclick="app.togglePasswordVisibility('cor-client-secret')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Sincronizaci贸n Autom谩tica</label>
                            <div class="cor-sync-options">
                                <label class="cor-checkbox-label">
                                    <input type="checkbox" id="cor-sync-auto">
                                    <span>Activar sincronizaci贸n autom谩tica</span>
                                </label>
                                <select id="cor-sync-intervalo" class="form-control cor-select-auto">
                                    <option value="1">Cada 1 hora</option>
                                    <option value="6">Cada 6 horas</option>
                                    <option value="12">Cada 12 horas</option>
                                    <option value="24" selected>Cada 24 horas</option>
                                    <option value="48">Cada 48 horas</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ltima Sincronizaci贸n</label>
                            <p id="cor-ultima-sync" style="color: #666;">Nunca</p>
                        </div>
                        <div class="cor-actions">
                            <button class="btn btn-primary" onclick="app.saveCorConfig()">
                                <i class="fas fa-save"></i> Guardar Configuraci贸n
                            </button>
                            <button class="btn btn-secondary" onclick="app.testCorConnection()">
                                <i class="fas fa-plug"></i> Probar Conexi贸n
                            </button>
                            <button class="btn btn-secondary" onclick="app.syncCorNow()">
                                <i class="fas fa-sync"></i> Sincronizar Ahora
                            </button>
                        </div>
                        <hr class="cor-divider">
                        <h3 class="cor-section-title">Importar Horas desde Excel</h3>
                        <p class="cor-description">
                            Importa horas reales desde un archivo Excel exportado de COR. El sistema detectar谩 autom谩ticamente las columnas y sugerir谩 mapeos.
                        </p>
                        <div class="form-group">
                            <label>Archivo Excel (.xlsx)</label>
                            <input type="file" id="cor-excel-file" accept=".xlsx,.xls" class="form-control">
                        </div>
                        <button class="btn btn-primary" onclick="app.previewCorImport()">
                            <i class="fas fa-file-excel"></i> Cargar y Previsualizar
                        </button>
                    </div>
                </div>

                <!-- Modal: Import Preview -->
                <div id="modal-cor-import" class="modal hidden">
                    <div class="modal-content modal-xl">
                        <div class="modal-header">
                            <h2><i class="fas fa-file-import"></i> Importar Horas desde COR</h2>
                            <button class="modal-close" onclick="app.closeCorImportModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Stepper -->
                            <div class="import-stepper">
                                <div class="step active" data-step="1">
                                    <span class="step-number">1</span>
                                    <span class="step-label">Preview</span>
                                </div>
                                <div class="step-line"></div>
                                <div class="step" data-step="2">
                                    <span class="step-number">2</span>
                                    <span class="step-label">Mapeo</span>
                                </div>
                                <div class="step-line"></div>
                                <div class="step" data-step="3">
                                    <span class="step-number">3</span>
                                    <span class="step-label">Confirmar</span>
                                </div>
                            </div>

                            <!-- Step 1: Preview -->
                            <div id="import-step-1" class="import-step">
                                <div class="import-summary-cards">
                                    <div class="summary-card success">
                                        <i class="fas fa-check-circle"></i>
                                        <div class="summary-value" id="summary-listos">0</div>
                                        <div class="summary-label">Listos para importar</div>
                                    </div>
                                    <div class="summary-card warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <div class="summary-value" id="summary-sin-mapear">0</div>
                                        <div class="summary-label">Sin mapear</div>
                                    </div>
                                    <div class="summary-card info">
                                        <i class="fas fa-copy"></i>
                                        <div class="summary-value" id="summary-duplicados">0</div>
                                        <div class="summary-label">Duplicados</div>
                                    </div>
                                </div>
                                <div class="import-filters">
                                    <label>
                                        <input type="checkbox" id="filter-sin-mapear" onchange="app.filterImportRows()">
                                        Mostrar solo sin mapear
                                    </label>
                                    <label>
                                        <input type="checkbox" id="filter-duplicados" onchange="app.filterImportRows()">
                                        Mostrar solo duplicados
                                    </label>
                                </div>
                                <div class="import-table-container">
                                    <table class="data-table import-preview-table">
                                        <thead>
                                            <tr>
                                                <th>Fila</th>
                                                <th>Usuario COR</th>
                                                <th>Colaborador</th>
                                                <th>Cliente/Proyecto COR</th>
                                                <th>Cliente</th>
                                                <th>Fecha</th>
                                                <th>Horas</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="import-preview-tbody"></tbody>
                                    </table>
                                </div>
                                <div class="import-pagination">
                                    <button class="btn btn-secondary" id="btn-prev-page" onclick="app.importPrevPage()">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </button>
                                    <span id="import-page-info">P谩gina 1 de 1</span>
                                    <button class="btn btn-secondary" id="btn-next-page" onclick="app.importNextPage()">
                                        Siguiente <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Step 2: Mapeo -->
                            <div id="import-step-2" class="import-step hidden">
                                <h3>Usuarios sin mapear</h3>
                                <p class="import-hint">Selecciona el colaborador correspondiente para cada usuario de COR</p>
                                <div class="mapeo-list" id="mapeo-usuarios-list"></div>

                                <h3 style="margin-top: 20px;">Proyectos/Clientes sin mapear</h3>
                                <p class="import-hint">Selecciona el cliente correspondiente para cada proyecto de COR</p>
                                <div class="mapeo-list" id="mapeo-proyectos-list"></div>
                            </div>

                            <!-- Step 3: Confirmar -->
                            <div id="import-step-3" class="import-step hidden">
                                <div class="import-final-summary">
                                    <h3>Resumen de Importaci贸n</h3>
                                    <div class="final-summary-grid">
                                        <div class="final-stat">
                                            <span class="final-stat-value" id="final-nuevos">0</span>
                                            <span class="final-stat-label">Nuevos registros</span>
                                        </div>
                                        <div class="final-stat">
                                            <span class="final-stat-value" id="final-sin-mapear">0</span>
                                            <span class="final-stat-label">Sin mapear (se ignorar谩n)</span>
                                        </div>
                                        <div class="final-stat">
                                            <span class="final-stat-value" id="final-duplicados">0</span>
                                            <span class="final-stat-label">Duplicados encontrados</span>
                                        </div>
                                    </div>

                                    <div id="duplicates-detail" class="duplicates-section hidden">
                                        <h4><i class="fas fa-copy"></i> Detalle de Duplicados</h4>
                                        <div class="duplicates-table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Colaborador</th>
                                                        <th>Cliente</th>
                                                        <th>Fecha</th>
                                                        <th>Horas Archivo</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="duplicates-tbody"></tbody>
                                            </table>
                                        </div>
                                        <div class="duplicate-action-selector">
                                            <label>驴Qu茅 hacer con los duplicados?</label>
                                            <div class="duplicate-options">
                                                <label class="radio-option">
                                                    <input type="radio" name="duplicate-action" value="ignore" checked>
                                                    <span><strong>Ignorar</strong> - Mantener datos existentes</span>
                                                </label>
                                                <label class="radio-option">
                                                    <input type="radio" name="duplicate-action" value="update">
                                                    <span><strong>Actualizar</strong> - Sobrescribir con nuevos datos</span>
                                                </label>
                                                <label class="radio-option">
                                                    <input type="radio" name="duplicate-action" value="sum">
                                                    <span><strong>Sumar</strong> - Agregar horas al registro existente</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="save-mapeos-option">
                                        <label>
                                            <input type="checkbox" id="save-mapeos-check" checked>
                                            Guardar mapeos para futuras importaciones
                                        </label>
                                    </div>

                                    <!-- Progress overlay -->
                                    <div id="import-progress-overlay" class="import-progress-overlay hidden">
                                        <div class="import-progress-content">
                                            <div class="import-progress-spinner">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                            <h4 id="import-progress-title">Importando registros...</h4>
                                            <div class="import-progress-bar-container">
                                                <div class="import-progress-bar" id="import-progress-bar"></div>
                                            </div>
                                            <p id="import-progress-text">Preparando importaci贸n...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="btn-import-back" onclick="app.importStepBack()" style="display: none;">
                                <i class="fas fa-arrow-left"></i> Atr谩s
                            </button>
                            <button class="btn btn-secondary" onclick="app.closeCorImportModal()">Cancelar</button>
                            <button class="btn btn-primary" id="btn-import-next" onclick="app.importStepNext()">
                                Siguiente <i class="fas fa-arrow-right"></i>
                            </button>
                            <button class="btn btn-primary" id="btn-import-confirm" onclick="app.confirmCorImport()" style="display: none;">
                                <i class="fas fa-check"></i> Importar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Config: Mapeo COR -->
                <div id="config-cor-mapeo" class="config-tab-content section-card hidden">
                    <div class="cor-mapeo-tabs">
                        <button class="btn btn-primary" id="btn-mapeo-proyectos" onclick="app.showCorMapeoTab('proyectos')">
                            Mapeo de Proyectos
                        </button>
                        <button class="btn btn-secondary" id="btn-mapeo-usuarios" onclick="app.showCorMapeoTab('usuarios')">
                            Mapeo de Usuarios
                        </button>
                        <div class="cor-mapeo-auto-btns">
                            <button class="btn btn-secondary" onclick="app.autoVincularProyectos()">
                                <i class="fas fa-magic"></i> Auto-vincular Proyectos
                            </button>
                            <button class="btn btn-secondary" onclick="app.autoVincularUsuarios()">
                                <i class="fas fa-magic"></i> Auto-vincular Usuarios
                            </button>
                        </div>
                    </div>

                    <!-- Mapeo Proyectos -->
                    <div id="cor-mapeo-proyectos">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Proyecto COR</th>
                                    <th>Cliente COR</th>
                                    <th>Cliente Local</th>
                                    <th>Vinculaci贸n</th>
                                    <th style="width: 150px; text-align: right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-cor-mapeo-proyectos"></tbody>
                        </table>
                    </div>

                    <!-- Mapeo Usuarios -->
                    <div id="cor-mapeo-usuarios" class="hidden">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Usuario COR</th>
                                    <th>Email COR</th>
                                    <th>Colaborador Local</th>
                                    <th>Vinculaci贸n</th>
                                    <th style="width: 150px; text-align: right;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="table-cor-mapeo-usuarios"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- COMPARATIVO VIEW -->
            <div id="view-comparativo" class="view-section hidden">
                <div class="section-header">
                    <h2 class="section-title">Real vs Planificado</h2>
                    <p class="section-subtitle">An谩lisis de eficiencia: comparaci贸n entre horas reales y planificadas</p>
                </div>

                <!-- Filtros -->
                <div class="section-card">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Regi贸n</label>
                            <select id="comp-region" class="form-control" onchange="app.onCompRegionChange()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Pa铆s</label>
                            <select id="comp-pais" class="form-control" onchange="app.onCompPaisChange()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>rea</label>
                            <select id="comp-area" class="form-control" onchange="app.loadComparativo()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Desde</label>
                            <input type="date" id="comp-fecha-desde" class="form-control" onchange="app.loadComparativo()">
                        </div>
                        <div class="filter-group">
                            <label>Hasta</label>
                            <input type="date" id="comp-fecha-hasta" class="form-control" onchange="app.loadComparativo()">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-secondary btn-sm" onclick="app.setCompDateRange('week')">Semana ant.</button>
                            <button class="btn btn-secondary btn-sm" onclick="app.setCompDateRange('month')">Mes</button>
                            <button class="btn btn-secondary btn-sm" onclick="app.setCompDateRange('quarter')">Trimestre</button>
                        </div>
                    </div>
                </div>

                <!-- KPIs Principales -->
                <div class="comp-kpi-grid">
                    <div class="comp-kpi-card">
                        <div class="comp-kpi-icon" style="background: #3498db;">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="comp-kpi-content">
                            <div class="comp-kpi-label">Horas Planificadas</div>
                            <div class="comp-kpi-value" id="kpi-planificadas">0h</div>
                        </div>
                    </div>
                    <div class="comp-kpi-card">
                        <div class="comp-kpi-icon" style="background: #9b59b6;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="comp-kpi-content">
                            <div class="comp-kpi-label">Horas Reales</div>
                            <div class="comp-kpi-value" id="kpi-reales">0h</div>
                        </div>
                    </div>
                    <div class="comp-kpi-card">
                        <div class="comp-kpi-icon" style="background: #e74c3c;">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <div class="comp-kpi-content">
                            <div class="comp-kpi-label">Diferencia</div>
                            <div class="comp-kpi-value" id="kpi-diferencia">0h</div>
                        </div>
                    </div>
                    <div class="comp-kpi-card">
                        <div class="comp-kpi-icon" style="background: #27ae60;">
                            <i class="fas fa-bullseye"></i>
                        </div>
                        <div class="comp-kpi-content">
                            <div class="comp-kpi-label">Precisi贸n</div>
                            <div class="comp-kpi-value" id="kpi-precision">0%</div>
                        </div>
                    </div>
                </div>

                <!-- KPIs Secundarios - Estado de Clientes -->
                <div class="comp-status-grid">
                    <div class="comp-status-card eficiente">
                        <div class="comp-status-value" id="kpi-eficientes">0</div>
                        <div class="comp-status-label">Clientes Eficientes</div>
                        <div class="comp-status-desc">Varianza 卤10%</div>
                    </div>
                    <div class="comp-status-card sobrepasado">
                        <div class="comp-status-value" id="kpi-sobrepasados">0</div>
                        <div class="comp-status-label">Sobrepasados</div>
                        <div class="comp-status-desc">Real > Plan (+10%)</div>
                    </div>
                    <div class="comp-status-card subutilizado">
                        <div class="comp-status-value" id="kpi-subutilizados">0</div>
                        <div class="comp-status-label">Subutilizados</div>
                        <div class="comp-status-desc">Real < Plan (-10%)</div>
                    </div>
                </div>

                <!-- Gr谩ficos Row 1: Eficiencia por Cliente/Mes + Horas por Mes -->
                <div class="comp-charts-row">
                    <div class="section-card comp-chart-card">
                        <h3 class="comp-chart-title">
                            <i class="fas fa-th"></i> Eficiencia por Cliente y Mes
                        </h3>
                        <p class="comp-chart-desc">% de cumplimiento por cliente en cada mes (top 8 clientes)</p>
                        <div class="comp-chart-container">
                            <canvas id="chart-scatter"></canvas>
                        </div>
                    </div>
                    <div class="section-card comp-chart-card">
                        <h3 class="comp-chart-title">
                            <i class="fas fa-chart-bar"></i> Horas por Mes
                        </h3>
                        <p class="comp-chart-desc">Comparativa de horas planificadas vs reales por mes</p>
                        <div class="comp-chart-container">
                            <canvas id="chart-trend"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr谩ficos Row 2: Barras horizontales con scroll -->
                <div class="comp-charts-row">
                    <div class="section-card comp-chart-card comp-chart-full">
                        <h3 class="comp-chart-title">
                            <i class="fas fa-chart-bar"></i> Top 10 - Varianza por Cliente
                        </h3>
                        <p class="comp-chart-desc">Desviaci贸n entre horas reales y planificadas (ordenado por mayor diferencia absoluta)</p>
                        <div class="comp-chart-container comp-chart-scroll" id="variance-container">
                            <canvas id="chart-variance"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr谩fico Row 3: Heatmap con scroll -->
                <div class="section-card">
                    <h3 class="comp-chart-title">
                        <i class="fas fa-th"></i> Distribuci贸n de Horas por Cliente
                    </h3>
                    <p class="comp-chart-desc">Horas totales por cliente en el per铆odo seleccionado</p>
                    <div class="comp-heatmap-container comp-scroll-container" id="heatmap-container">
                        <div class="comp-heatmap-empty">Seleccione filtros para ver los datos</div>
                    </div>
                </div>

                <!-- Gr谩fico Detalle por Colaborador -->
                <div class="section-card comp-chart-card comp-chart-full">
                    <h3 class="comp-chart-title">
                        <i class="fas fa-users"></i> Horas por Colaborador
                        <span id="comp-table-filter-badge" class="comp-filter-badge hidden"></span>
                        <button id="comp-clear-filter" class="btn btn-sm btn-outline hidden" onclick="app.filterByClient(app.selectedClientId)" style="margin-left: auto; font-size: 11px;">
                            <i class="fas fa-times"></i> Quitar filtro
                        </button>
                    </h3>
                    <p class="comp-chart-desc">Comparativa de horas planificadas vs reales por colaborador (agrupado por cliente)</p>
                    <div class="comp-chart-container comp-chart-tall" id="chart-colaborador-container">
                        <canvas id="chart-colaborador"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <!-- MODALS -->
        <div id="crud-modal" class="modal hidden">
            <div class="modal-overlay" onclick="app.closeModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">A帽adir Registro</h3>
                    <button class="modal-close" onclick="app.closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="crud-form" onsubmit="event.preventDefault(); app.saveRecord();">
                        <div class="form-group">
                            <label id="name-label">Nombre</label>
                            <input type="text" id="record-name" class="form-control" required>
                        </div>
                        <!-- Campo para Regiones: es_global -->
                        <div id="region-fields" class="hidden">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="region-es-global">
                                    <span>Es Global (para 谩reas transversales)</span>
                                </label>
                            </div>
                        </div>
                        <!-- Campos para Pa铆ses: region, es_global -->
                        <div id="pais-fields" class="hidden">
                            <div class="form-group">
                                <label>Regi贸n</label>
                                <select id="pais-region" class="form-control" required>
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="pais-es-global">
                                    <span>Es Global (para pa铆s transversal)</span>
                                </label>
                            </div>
                        </div>
                        <!-- Campos para reas: region, pa铆s -->
                        <div id="area-fields" class="hidden">
                            <div class="form-group">
                                <label>Regi贸n</label>
                                <select id="area-region" class="form-control" onchange="app.onAreaModalRegionChange()">
                                    <option value="">-- Sin regi贸n --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pa铆s</label>
                                <select id="area-pais" class="form-control">
                                    <option value="">-- Sin pa铆s --</option>
                                </select>
                            </div>
                        </div>
                        <div id="colaborador-area-field" class="hidden">
                            <div class="form-group">
                                <label>rea</label>
                                <select id="colaborador-area" class="form-control">
                                    <option value="">-- Sin 谩rea --</option>
                                </select>
                            </div>
                        </div>
                        <div id="cliente-fields" class="hidden">
                            <div class="form-group">
                                <label>Regi贸n</label>
                                <select id="cliente-region" class="form-control" onchange="app.onClienteModalRegionChange()">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Pa铆s</label>
                                <select id="cliente-pais" class="form-control">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Proyecto</label>
                                <select id="record-proyecto" class="form-control">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Proyecto</label>
                                <select id="record-tipo" class="form-control">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>rea</label>
                                <select id="record-area" class="form-control">
                                    <option value="">-- Seleccionar --</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="app.closeModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="app.saveRecord()">Guardar</button>
                </div>
            </div>
        </div>

        <div id="import-modal" class="modal hidden">
            <div class="modal-overlay" onclick="app.closeImportModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Importar desde CSV</h3>
                    <button class="modal-close" onclick="app.closeImportModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <input type="file" id="csv-file-input" accept=".csv" class="form-control">
                        <p style="font-size: 13px; color: var(--llyc-gray-subtext); margin-top: 8px;">Selecciona un
                            archivo CSV. La primera columna debe contener los nombres.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="app.closeImportModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="app.importCSV()">Importar</button>
                </div>
            </div>
        </div>

        <div id="allocation-modal" class="modal hidden">
            <div class="modal-overlay" onclick="app.closeAllocationModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="alloc-modal-title">Editar Asignaci贸n</h3>
                    <button class="modal-close" onclick="app.closeAllocationModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="alloc-form" onsubmit="event.preventDefault(); app.saveAllocation();">
                        <input type="hidden" id="alloc-id">
                        <input type="hidden" id="alloc-colaborador-id">
                        <input type="hidden" id="alloc-date">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select id="alloc-cliente" class="form-control" required>
                                <option value="">-- Seleccionar --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Horas</label>
                            <input type="number" id="alloc-hours" class="form-control" min="0.5" step="0.5" max="24"
                                required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" id="btn-delete-alloc" onclick="app.deleteAllocation()"
                        style="margin-right: auto;">Eliminar</button>
                    <button class="btn btn-secondary" onclick="app.closeAllocationModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="app.saveAllocation()">Guardar</button>
                </div>
            </div>
        </div>
    </div>        <!-- User Modal -->
        <div id="user-modal" class="modal hidden">
            <div class="modal-overlay" onclick="app.closeUserModal()"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="user-modal-title">A帽adir Usuario</h3>
                    <button class="modal-close" onclick="app.closeUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <input type="hidden" id="user-id">
                        <div class="form-group">
                            <label>Usuario</label>
                            <input type="text" id="user-username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" id="user-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Contrase帽a</label>
                            <input type="password" id="user-password" class="form-control" placeholder="Dejar vac铆o para no cambiar">
                        </div>
                        <div class="form-group">
                            <label>Rol</label>
                            <select id="user-role" class="form-control" required>
                                <option value="">-- Seleccionar --</option>
                                <option value="administrador">Administrador</option>
                                <option value="visualizador">Visualizador</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>rea</label>
                            <select id="user-area" class="form-control">
                                <option value="">-- Sin 谩rea asignada (acceso a todas) --</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="app.closeUserModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="app.saveUser()">Guardar</button>
                </div>
            </div>
        </div>


    <script src="app.js?v=38"></script>
    <script src="dashboard.js?v=33"></script>
</body>

</html>